<!DOCTYPE html>
<html>
<head>
    <title>Audio Streaming Test</title>
</head>
<body>
    <h1>WebMux Audio Test</h1>
    <button id="testTone">Test Tone (should work)</button>
    <button id="testWebM">Test WebM Playback</button>
    <button id="startStream">Start Live Stream</button>
    <button id="stopStream">Stop Stream</button>
    <div id="status"></div>
    <audio id="audio" controls></audio>

    <script>
        const status = document.getElementById('status');
        const audio = document.getElementById('audio');
        let ws = null;
        let mediaSource = null;
        let sourceBuffer = null;
        let queue = [];

        // Test basic tone
        document.getElementById('testTone').onclick = () => {
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.value = 0.1;
            osc.frequency.value = 440;
            osc.start();
            setTimeout(() => osc.stop(), 1000);
            status.textContent = 'Playing test tone...';
        };

        // Test WebM file playback
        document.getElementById('testWebM').onclick = () => {
            // Create a minimal WebM file with opus audio
            audio.src = 'test_audio.webm';
            audio.play().then(() => {
                status.textContent = 'Playing WebM file...';
            }).catch(e => {
                status.textContent = 'WebM playback failed: ' + e.message;
            });
        };

        // Start streaming
        document.getElementById('startStream').onclick = () => {
            status.textContent = 'Connecting...';
            
            // Create MediaSource
            mediaSource = new MediaSource();
            audio.src = URL.createObjectURL(mediaSource);
            
            mediaSource.addEventListener('sourceopen', () => {
                status.textContent = 'MediaSource opened, creating buffer...';
                try {
                    sourceBuffer = mediaSource.addSourceBuffer('audio/webm; codecs="opus"');
                    sourceBuffer.addEventListener('updateend', processQueue);
                    status.textContent = 'Buffer created, connecting WebSocket...';
                    connectWebSocket();
                } catch (e) {
                    status.textContent = 'Failed to create buffer: ' + e.message;
                }
            });
        };

        // Stop streaming
        document.getElementById('stopStream').onclick = () => {
            if (ws) {
                ws.send(JSON.stringify({ type: 'audio-control', action: 'stop' }));
                ws.close();
                ws = null;
            }
            status.textContent = 'Stopped';
        };

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:4000/ws');
            
            ws.onopen = () => {
                status.textContent = 'WebSocket connected, starting audio...';
                ws.send(JSON.stringify({ type: 'audio-control', action: 'start' }));
            };
            
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'audio-stream') {
                    // Decode base64
                    const binaryString = atob(msg.data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    queue.push(bytes);
                    processQueue();
                } else if (msg.type === 'audio-status') {
                    status.textContent = 'Audio status: ' + JSON.stringify(msg);
                }
            };
            
            ws.onerror = (e) => {
                status.textContent = 'WebSocket error';
            };
        }

        function processQueue() {
            if (queue.length === 0 || sourceBuffer.updating) return;
            
            const chunk = queue.shift();
            try {
                sourceBuffer.appendBuffer(chunk);
                status.textContent = `Buffering... (${queue.length} chunks queued)`;
                
                // Try to play
                if (audio.paused && audio.buffered.length > 0) {
                    audio.play().then(() => {
                        status.textContent = 'Playing!';
                    }).catch(e => {
                        status.textContent = 'Play failed: ' + e.message;
                    });
                }
            } catch (e) {
                status.textContent = 'Buffer error: ' + e.message;
            }
        }
    </script>
</body>
</html>